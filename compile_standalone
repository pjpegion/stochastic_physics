#!/bin/sh -x
SRC_DIR=../
compile_all=1
FC=mpiifort
INCS="-I. -I${SRC_DIR}/FV3/ccpp/include/ -I${SRC_DIR}FV3/gfsphysics/ -I${SRC_DIR}/FMS/include -I${SRC_DIR}/FV3/atmos_cubed_sphere -I${SRC_DIR}/FMS/fv3gfs"
#OPT_FLAGS="-C -traceback "
OPT_FLAGS="-g -O0 -C -fp-stack-check -fstack-protector-all -fpe0 -debug -traceback -ftrapuv"
#OPT_FLAGS='-traceback -O2 -debug minimal -fp-model source -qoverride-limits -qopt-prefetch=3'
FLAGS64=$OPT_FLAGS" -qopenmp -real-size 64 -DSTOCHY_UNIT_TEST -c "$INCS
FLAGS=$OPT_FLAGS" -qopenmp -DSTOCHY_UNIT_TEST -c "$INCS
echo $FLAGS
if [ $compile_all -eq 1 ];then
   rm -f *.i90 *.i *.o *.mod lib*a
   $FC ${FLAGS64} fv_control_stub.F90
   $FC ${FLAGS64} atmosphere_stub.F90
   $FC ${FLAGS64} stochy_namelist_def.F90
   $FC ${FLAGS64} spectral_layout.F90
   $FC ${FLAGS64} pln2eo_stochy.f
   $FC ${FLAGS64} setlats_a_stochy.f
   $FC ${FLAGS64} setlats_lag_stochy.f
   $FC ${FLAGS64} glats_stochy.f
   $FC ${FLAGS64} gozrineo_stochy.f
   $FC ${FLAGS64} dezouv_stochy.f
   $FC ${FLAGS64} dozeuv_stochy.f
   $FC ${FLAGS64} epslon_stochy.f
   $FC ${FLAGS64} four_to_grid_stochy.f
   $FC ${FLAGS64} sumfln_stochy.f
   $FC ${FLAGS64} get_lats_node_a_stochy.f
   $FC ${FLAGS64} get_ls_node_stochy.f
   $FC ${FLAGS64} compns_stochy.F90
   $FC ${FLAGS64} stochy_internal_state_mod.F90
   $FC ${FLAGS64} getcon_lag_stochy.f
   $FC ${FLAGS64} getcon_spectral.F90
   $FC ${FLAGS64} initialize_spectral_mod.F90
   $FC ${FLAGS64} standalone_stochy_module.F90
   $FC ${FLAGS64} stochy_patterngenerator.F90
   $FC ${FLAGS64} stochy_data_mod.F90
   $FC ${FLAGS64} get_stochy_pattern.F90
   $FC ${FLAGS64} stochastic_physics.F90
   ar rv libstochastic_physics.a *.o
fi
#rm libstochastic_physics.a
#$FC ${FLAGS64} spectral_layout.F90
#$FC ${FLAGS64} get_stochy_pattern.F90
#$FC ${FLAGS64} stochastic_physics.F90
ar rv libstochastic_physics.a *.o
$FC -C -g -traceback -real-size 64 -o standalone_stochy standalone_stochy.F90 ${INCS} -I/apps/contrib/NCEPLIBS/lib//netcdfp/include -L. -lstochastic_physics /work/noaa/gsienkf/ppegion/fv3_coupled_pjp/FV3/FV3_INSTALL/libfv3cap.a /work/noaa/gsienkf/ppegion/fv3_coupled_pjp/FV3/FV3_INSTALL/libccppdriver.a /work/noaa/gsienkf/ppegion/fv3_coupled_pjp/FV3/FV3_INSTALL/libfv3core.a /work/noaa/gsienkf/ppegion/fv3_coupled_pjp/FV3/FV3_INSTALL/libfv3io.a /work/noaa/gsienkf/ppegion/fv3_coupled_pjp/FV3/FV3_INSTALL/libipd.a /work/noaa/gsienkf/ppegion/fv3_coupled_pjp/FV3/FV3_INSTALL/libgfsphys.a /work/noaa/gsienkf/ppegion/fv3_coupled_pjp/FV3/FV3_INSTALL/libfv3cpl.a /work/noaa/gsienkf/ppegion/fv3_coupled_pjp/FMS/FMS_INSTALL/libfms.a -L/work/noaa/gsienkf/ppegion/fv3_coupled_pjp/FV3/ccpp/lib -lccpp -lccppphys /apps/contrib/NCEPLIBS/lib/gfs_post.fd/v8.0.5/intel/libncep_post_4.a /apps/contrib/NCEPLIBS/orion/lib/libnemsio_v2.2.4.a /apps/contrib/NCEPLIBS/orion/lib/libg2_v3.1.1_4.a /apps/contrib/NCEPLIBS/orion/lib/libg2tmpl_v1.6.0.a /apps/contrib/NCEPLIBS/orion/lib/libbacio_v2.0.3_4.a /apps/contrib/NCEPLIBS/orion/lib/libsp_v2.0.3_d.a /apps/contrib/NCEPLIBS/orion/lib/libw3emc_v2.4.0_d.a /apps/contrib/NCEPLIBS/orion/lib/libw3nco_v2.0.7_d.a /apps/contrib/NCEPLIBS/orion/lib/libcrtm_v2.3.0.a /apps/contrib/NCEPLIBS/orion/lib/libpng_v1.2.44/libpng.a /apps/contrib/NCEPLIBS/orion/lib/libjasper_v1.900.2/libjasper.a /apps/contrib/NCEPLIBS/orion/lib/libz_v1.2.6.a -L/apps/contrib/NCEPLIBS/lib/EXTERNAL/LOCAL_EXTERN/ESMF_8.0.0.para/lib -Wl,-rpath,/apps/contrib/NCEPLIBS/lib/EXTERNAL/LOCAL_EXTERN/ESMF_8.0.0.para/lib -lesmf  -cxxlib -lrt -ldl  -lnetcdff -lnetcdf -L/apps/contrib/NCEPLIBS/l.0110.2020/lib/netcdfp/lib  -lhdf5 -lhdf5_hl -lhdf5 -lz  -qopenmp  -L/apps/contrib/NCEPLIBS/lib//netcdfp/lib -lnetcdff -lnetcdf
